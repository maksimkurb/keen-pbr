#!/bin/sh

. /opt/etc/keenetic-pbr/defaults

log()
{
  logger -t "keenetic-pbr" "$1"
  echo "${ansi_blue}[keenetic-pbr]${ansi_white} $1${ansi_std}" >&2
}

enable_hwnat()
{
  log "Enabling HW NAT..."
  sysctl -w net.ipv4.netfilter.ip_conntrack_fastnat=1 2>/dev/null || true # NDMS2
  sysctl -w net.netfilter.nf_conntrack_fastnat=1 2>/dev/null || true # NDMS3
}

disable_hwnat()
{
  log "Disabling HW NAT..."
  sysctl -w net.ipv4.netfilter.ip_conntrack_fastnat=0 2>/dev/null || true # NDMS2
  sysctl -w net.netfilter.nf_conntrack_fastnat=0 2>/dev/null || true # NDMS3
}

apply_lists_and_routing()
{
  log "Applying routing configuration and importing IPs/CIDRs to ipsets..."
  $KEENETIC_PBR -config "$CONFIG" apply
}

apply_routing()
{
  log "Applying routing configuration..."
  $KEENETIC_PBR -config "$CONFIG" apply -skip-ipset
}

unapply_routing()
{
  log "Removing routing configuration..."
  $KEENETIC_PBR -config "$CONFIG" undo-routing
}

start_dnsmasq()
{
  log "Starting dnsmasq with keenetic-pbr config..."
  $DNSMASQ --conf-script /opt/etc/init.d/S80keenetic-pbr generate-dnsmasq-config || log "Failed to start dnsmasq"
  log "dnsmasq started"
}

stop_dnsmasq()
{
  log "Stopping dnsmasq..."
  /opt/etc/init.d/S56dnsmasq stop || true
}

restart_dnsmasq()
{
  stop_dnsmasq
  start_dnsmasq
}

check_dnsmasq() {
    echo -e -n "$ansi_white Checking dnsmasq... $ansi_std"

    dnsmasq_pid=$(pidof $DNSMASQ)
    if [ -n "$dnsmasq_pid" ]; then

        if cat /proc/$dnsmasq_pid/cmdline | grep -- "generate-dnsmasq-config"; then
            echo -e "            $ansi_green alive and configured by keenetic-pbr. $ansi_std";
            return 0
        else
            echo -e "            $ansi_yellow alive but not configured by keenetic-pbr. $ansi_std";
            echo -e "$ansi_yellow dnsmasq cmdline is '$(cat /proc/$dnsmasq_pid/cmdline)' $ansi_std";
            return 1
        fi

    else
        echo -e "            $ansi_red dead. $ansi_std";
        return 1
    fi
}

generate_dnsmasq_config()
{
  cat $DNSMASQ_CONFIG

  echo ""
  echo "# ipsets generated by keenetic-pbr below"
  $KEENETIC_PBR -config "$CONFIG" print-dnsmasq-config
}

start()
{
  disable_hwnat
  apply_lists_and_routing
  restart_dnsmasq
}

stop()
{
  enable_hwnat
  unapply_routing
  stop_dnsmasq
}

case "$1" in
  start)
    start
    ;;
  stop)
    stop
    ;;
  restart)
    stop
    sleep 2
    start
    ;;
  download-lists|download_lists|update)
    log "Downloading lists..."
    $KEENETIC_PBR -config "$CONFIG" download
    log "Lists downloaded. Please run '/opt/etc/init.d/S80keenetic-pbr restart' to make use of them or restart OPKG."
    ;;
  apply-lists|apply_lists)
    apply_lists_and_routing
    ;;
  apply-routing|apply_routing)
    apply_routing
    ;;
  self-check|self_check)
    $KEENETIC_PBR -config "$CONFIG" self-check
    ;;
  generate-dnsmasq-config)
    generate_dnsmasq_config
    ;;
  check|status)
    check_dnsmasq
    ;;
  *)
    echo "Usage: $0 {start|stop|restart|check|status|self-check|download-lists|apply-lists|apply-routing}"
    ;;
esac