# keen-pbr - –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –≤—ã–±–æ—Ä–æ—á–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –Ω–∞ —Ä–æ—É—Ç–µ—Ä–∞—Ö Keenetic

![workflow status](https://img.shields.io/github/actions/workflow/status/maksimkurb/keen-pbr/.github%2Fworkflows%2Fbuild-ci.yml?branch=main)
![release](https://img.shields.io/github/v/release/maksimkurb/keen-pbr?sort=date)

> **keen-pbr** –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º –ø—Ä–æ–¥—É–∫—Ç–æ–º –∫–æ–º–ø–∞–Ω–∏–∏ **Keenetic** –∏ –Ω–∏–∫–∞–∫ —Å –Ω–µ–π –Ω–µ —Å–≤—è–∑–∞–Ω. –≠—Ç–æ—Ç –ø–∞–∫–µ—Ç —Å–æ–∑–¥–∞–Ω —Å—Ç–æ—Ä–æ–Ω–Ω–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è "–∫–∞–∫ –µ—Å—Ç—å" –±–µ–∑ –∫–∞–∫–æ–π-–ª–∏–±–æ –≥–∞—Ä–∞–Ω—Ç–∏–∏, –∞–≤—Ç–æ—Ä –Ω–µ –Ω–µ—Å—ë—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ –í–∞—à–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –í—ã –≤—ã–ø–æ–ª–Ω—è–µ—Ç–µ –Ω–∞ —Å–≤–æ–π —Å—Ç—Ä–∞—Ö –∏ —Ä–∏—Å–∫.
>
>  –í–æ–ø—Ä–æ—Å—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∫–∞—Å–∞—Ç–µ–ª—å–Ω–æ –ø–∞–∫–µ—Ç–∞ –º–æ–∂–Ω–æ –Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å –≤ [GitHub Issue](https://github.com/maksimkurb/keen-pbr/issues) –∏ –≤ Telegram-—á–∞—Ç: https://t.me/keen_pbr.

#### [> README in English <](./README.en.md)

#### ‚ö†Ô∏è–î–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤ —Ä–æ—É—Ç–µ—Ä–æ–≤ Keenetic –±–µ–∑ USB-—Ä–∞–∑—ä—ë–º–∞:
* –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –æ–±–Ω–æ–≤–∏–ª–∏—Å—å –∫–∞–∫ –º–∏–Ω–∏–º—É–º –¥–æ –≤–µ—Ä—Å–∏–∏ `v-1.3.0-2`
* [–û—Ç–∫–ª—é—á–∏—Ç–µ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤](#config-step-3) –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞–∫–µ—Ç–∞

–í—Å—ë —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∏–∑–ª–∏—à–Ω–∏–π –∏–∑–Ω–æ—Å NAND-–ø–∞–º—è—Ç–∏ —Ä–æ—É—Ç–µ—Ä–∞.

---

**keen-pbr** ‚Äî —ç—Ç–æ –ø–∞–∫–µ—Ç –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∞–≤–∏–ª –¥–ª—è —Ä–æ—É—Ç–µ—Ä–æ–≤ Keenetic.

Telegram-—á–∞—Ç –ø—Ä–æ–µ–∫—Ç–∞: https://t.me/keen_pbr

–° –ø–æ–º–æ—â—å—é —ç—Ç–æ–≥–æ –ø–∞–∫–µ—Ç–∞ –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤—ã–±–æ—Ä–æ—á–Ω—É—é –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω—ã—Ö IP-–∞–¥—Ä–µ—Å–æ–≤, –ø–æ–¥—Å–µ—Ç–µ–π –∏ –¥–æ–º–µ–Ω–æ–≤. –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ, –µ—Å–ª–∏ –≤–∞–º –ø–æ–Ω–∞–¥–æ–±–∏–ª–æ—Å—å –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –∑–∞—â–∏—â–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º —Ä–µ—Å—É—Ä—Å–∞–º, –ª–∏–±–æ –≤—ã–±–æ—Ä–æ—á–Ω–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å —Ç—Ä–∞—Ñ–∏–∫ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ (–Ω–∞–ø—Ä. —Ç—Ä–∞—Ñ–∏–∫ –¥–æ —Å–∞–π—Ç–∞ –ê –∏–¥—ë—Ç —á–µ—Ä–µ–∑ –æ–¥–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞, –∞ –æ—Å—Ç–∞–ª—å–Ω–æ–π —Ç—Ä–∞—Ñ–∏–∫ - —á–µ—Ä–µ–∑ –¥—Ä—É–≥–æ–≥–æ)

–ü–∞–∫–µ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `ipset` –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —Ö—Ä–∞–Ω–∏—Ç—å –±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–¥—Ä–µ—Å–æ–≤ –≤ –ø–∞–º—è—Ç–∏ —Ä–æ—É—Ç–µ—Ä–∞ –±–µ–∑ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —É–≤–µ–ª–∏—á–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏, –∞ —Ç–∞–∫–∂–µ `dnsmasq` –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø–æ–ø–æ–ª–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–π `ipset` IP-–∞–¥—Ä–µ—Å–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∑–æ–ª–≤—è—Ç –∫–ª–∏–µ–Ω—Ç—ã –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏.

–î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –ø–∞–∫–µ—Ç —Å–æ–∑–¥–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `/opt/etc/ndm/netfilter.d` –∏ `/opt/etc/ndm/ifstatechanged.d`.

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ–º–µ–Ω–æ–≤ —á–µ—Ä–µ–∑ `dnsmasq`
- –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ IP-–∞–¥—Ä–µ—Å–æ–≤ —á–µ—Ä–µ–∑ `ipset`
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ `dnsmasq`

## –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã

–î–∞–Ω–Ω—ã–π –ø–∞–∫–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–µ–¥—É—é—â–∏–µ —Å–∫—Ä–∏–ø—Ç—ã –∏ —É—Ç–∏–ª–∏—Ç—ã:
```
/opt
‚îú‚îÄ‚îÄ /usr
‚îÇ   ‚îî‚îÄ‚îÄ /bin
‚îÇ       ‚îî‚îÄ‚îÄ keen-pbr                    # –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ø–∏—Å–∫–æ–≤, –∏—Ö –∏–º–ø–æ—Ä—Ç–∞ –≤ ipset, –∞ —Ç–∞–∫–∂–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è dnsmasq
‚îî‚îÄ‚îÄ /etc
    ‚îú‚îÄ‚îÄ /keen-pbr
    ‚îÇ   ‚îú‚îÄ‚îÄ /keen-pbr.conf              # –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ keen-pbr
    ‚îÇ   ‚îú‚îÄ‚îÄ /lists.d                    # –í —ç—Ç—É –ø–∞–ø–∫—É keen-pbr –±—É–¥–µ—Ç –ø–æ–º–µ—â–∞—Ç—å —Å–∫–∞—á–∞–Ω–Ω—ã–µ –∏ –ª–æ–∫–∞–ª—å–Ω—ã–µ —Å–ø–∏—Å–∫–∏. –ù–µ –∫–ª–∞–¥–∏—Ç–µ —Å—é–¥–∞ –Ω–∏—á–µ–≥–æ —Å–∞–º–∏, —Ç.–∫. —Ñ–∞–π–ª—ã –∏–∑ —ç—Ç–æ–π –ø–∞–ø–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –∫–æ–º–∞–Ω–¥—ã "keen-pbr download".
    ‚îÇ   ‚îî‚îÄ‚îÄ /local.lst                  # –°–ø–∏—Å–æ–∫ IP/CIDR/domain –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    ‚îú‚îÄ‚îÄ /ndm
    ‚îÇ   ‚îú‚îÄ‚îÄ /netfilter.d
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 50-keen-pbr-fwmarks.sh  # –°–∫—Ä–∏–ø—Ç –¥–æ–±–∞–≤–ª—è–µ—Ç iptables –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏ –ø–∞–∫–µ—Ç–æ–≤ –≤ ipset —Å –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º fwmark
    ‚îÇ   ‚îî‚îÄ‚îÄ /ifstatechanged.d
    ‚îÇ       ‚îî‚îÄ‚îÄ 50-keen-pbr-routing.sh  # –°–∫—Ä–∏–ø—Ç –¥–æ–±–∞–≤–ª—è–µ—Ç ip rule –¥–ª—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–∫–µ—Ç–æ–≤ —Å fwmark –≤ –Ω—É–∂–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∏ —Å–æ–∑–¥–∞—ë—Ç –µ—ë —Å –Ω—É–∂–Ω—ã–º default gateway
    ‚îú‚îÄ‚îÄ /cron.daily
    ‚îÇ   ‚îî‚îÄ‚îÄ 50-keen-pbr-lists-update.sh # –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–æ–≤
    ‚îî‚îÄ‚îÄ /dnsmasq.d
        ‚îî‚îÄ‚îÄ (config files)                  # –ü–∞–ø–∫–∞ —Å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º–∏ –¥–ª—è dnsmasq, –∑–∞—Å—Ç–∞–≤–ª—è—é—â–∏–º–∏ –µ–≥–æ –∫–ª–∞—Å—Ç—å IP-–∞–¥—Ä–µ—Å–∞ –¥–æ–º–µ–Ω–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–æ–≤ –≤ –Ω—É–∂–Ω—ã–π ipset
```

### –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–∞–∫–µ—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ IP-–∞–¥—Ä–µ—Å–æ–≤ –∏ –ø–æ–¥—Å–µ—Ç–µ–π
**keen-pbr** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç ip-–∞–¥—Ä–µ—Å–∞ –∏ –ø–æ–¥—Å–µ—Ç–∏ –∏–∑ —Å–ø–∏—Å–∫–æ–≤ –≤ –Ω—É–∂–Ω—ã–µ `ipset`. –î–∞–ª–µ–µ –ø–∞–∫–µ—Ç—ã –Ω–∞ IP-–∞–¥—Ä–µ—Å–∞, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ —ç—Ç–æ—Ç `ipset`, –º–∞—Ä–∫–∏—Ä—É—é—Ç—Å—è –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º `fwmark` –∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∞–≤–∏–ª –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–æ–≤—ã–≤–∞—é—Ç—Å—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.

**–°—Ö–µ–º–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞:**
![IP routing scheme](./.github/docs/ip-routing.svg)

### –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–∞–∫–µ—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ–º–µ–Ω–æ–≤
–î–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ–º–µ–Ω–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `dnsmasq`. –ö–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç—ã –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏ –¥–µ–ª–∞—é—Ç DNS-–∑–∞–ø—Ä–æ—Å, `dnsmasq` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –¥–æ–º–µ–Ω –≤ —Å–ø–∏—Å–∫–∞—Ö, –∏ –µ—Å–ª–∏ –µ—Å—Ç—å, —Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç –µ–≥–æ ip-–∞–¥—Ä–µ—Å–∞ –≤ `ipset`.

> [!NOTE]  
> –ß—Ç–æ–±—ã –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –¥–æ–º–µ–Ω–æ–≤ —Ä–∞–±–æ—Ç–∞–ª–∞, –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ DNS-—Å–µ—Ä–≤–µ—Ä–∞. –ò—Ö DNS-—Å–µ—Ä–≤–µ—Ä–æ–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å IP —Ä–æ—É—Ç–µ—Ä–∞, –∏–Ω–∞—á–µ `dnsmasq` –Ω–µ —É–≤–∏–¥–∏—Ç —ç—Ç–∏ –ø–∞–∫–µ—Ç—ã –∏ –Ω–µ –¥–æ–±–∞–≤–∏—Ç ip-–∞–¥—Ä–µ—Å–∞ –≤ –Ω—É–∂–Ω—ã–π `ipset`.

> [!IMPORTANT]  
> –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –∏–≥—Ä—É—à–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –ø–æ–ª—É—á–µ–Ω–∏—è ip-–∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è —Å–≤–æ–∏—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤. –î–ª—è —Ç–∞–∫–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ –¥–æ–º–µ–Ω–∞–º –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, —Ç.–∫. —ç—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ –¥–µ–ª–∞—é—Ç DNS-–∑–∞–ø—Ä–æ—Å–æ–≤. –í–∞–º –ø—Ä–∏–¥—ë—Ç—Å—è —É–∑–Ω–∞–≤–∞—Ç—å IP-–∞–¥—Ä–µ—Å–∞/–ø–æ–¥—Å–µ—Ç–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ —ç—Ç–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –∏ –¥–æ–±–∞–≤–ª—è—Ç—å –∏—Ö –≤ —Å–ø–∏—Å–∫–∏ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ. 

**–°—Ö–µ–º–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞:**
![Domain routing scheme](./.github/docs/domain-routing.svg)

## –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–æ—É—Ç–µ—Ä–∞
1. –†–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –ø–∞–∫–µ—Ç–∞ –ø—Ä–æ–≤–µ—Ä—è–ª–∞—Å—å –Ω–∞ **Keenetic OS** –≤–µ—Ä—Å–∏–∏ **4.2.1**. –†–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –Ω–∞ –≤–µ—Ä—Å–∏–∏ **3.x.x** –≤–æ–∑–º–æ–∂–Ω–∞, –Ω–æ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è.
2. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–∞ –≤–∞—à —Ä–æ—É—Ç–µ—Ä –≤ —Ä–∞–∑–¥–µ–ª–µ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -> –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∏—Å—Ç–µ–º—ã:
   - **–°–µ—Ç–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ / –ü—Ä–æ—Ç–æ–∫–æ–ª IPv6**
     - –≠—Ç–æ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ "–ú–æ–¥—É–ª–∏ —è–¥—Ä–∞ –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã Netfilter". 
   - **–ü–∞–∫–µ—Ç—ã OPKG / –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–∞–∫–µ—Ç–æ–≤**
   - **–ü–∞–∫–µ—Ç—ã OPKG / –ú–æ–¥—É–ª–∏ —è–¥—Ä–∞ –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã Netfilter**
   - **–ü–∞–∫–µ—Ç—ã OPKG / –ü–∞–∫–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è Xtables-addons –¥–ª—è Netfilter**
     - –ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —ç—Ç–æ—Ç –ø–∞–∫–µ—Ç –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω, –ø–æ—Å–∫–æ–ª—å–∫—É –µ–≥–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è keen-pbr, –Ω–æ –µ–≥–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –º–æ–≥—É—Ç –ø—Ä–∏–≥–æ–¥–∏—Ç—å—Å—è –≤ –±—É–¥—É—â–µ–º. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∫ –º–æ–¥—É–ª—é [–¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ —Å—Å—ã–ª–∫–µ](https://manpages.ubuntu.com/manpages/trusty/en/man8/xtables-addons.8.html).
3. –í–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ä–µ–¥—É Entware –Ω–∞ Keenetic ([–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è](https://help.keenetic.com/hc/ru/articles/360021214160-%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B-%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2-%D1%80%D0%B5%D0%BF%D0%BE%D0%B7%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D1%8F-Entware-%D0%BD%D0%B0-USB-%D0%BD%D0%B0%D0%BA%D0%BE%D0%BF%D0%B8%D1%82%D0%B5%D0%BB%D1%8C)), –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è USB-–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –≤—Å—Ç–∞–≤–ª–µ–Ω –≤ —Ä–æ—É—Ç–µ—Ä
4. –¢–∞–∫–∂–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤—Ç–æ—Ä–æ–µ (—Ç—Ä–µ—Ç—å–µ, —á–µ—Ç–≤—ë—Ä—Ç–æ–µ, ...) —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä–æ–µ –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–∏—Ç—å —Ç—Ä–∞—Ñ–∏–∫ –ø–æ–ø–∞–¥–∞—é—â–∏–π –ø–æ–¥ —Å–ø–∏—Å–∫–∏. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å VPN-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏–ª–∏ –≤—Ç–æ—Ä–æ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä (multi-WAN).
5. **–í–∞—à–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –ü–æ–ª–∏—Ç–∏–∫–µ –¥–æ—Å—Ç—É–ø–∞ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é** (—Ä–∞–∑–¥–µ–ª –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π -> –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫). –í –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –º–æ–∂–µ—Ç –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞, –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ keen-pbr.

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

<details>
<summary><strong>üÜï –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å –≤–µ—Ä—Å–∏–∏ 1.x.x –Ω–∞ 2.x.x</strong></summary>
–í –≤–µ—Ä—Å–∏–∏ 2.0.0 –ø–∞–∫–µ—Ç –±—ã–ª –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω –∏–∑ `keenetic-pbr` –≤ `keen-pbr`. –ü–æ–º–µ–Ω—è–ª–∏—Å—å –ø—É—Ç–∏ –∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º —Ñ–∞–π–ª–∞–º –∏ –Ω–∞–∑–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª–Ω—è–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤.

–ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–∑ –≤–µ—Ä—Å–∏–∏ **1.x.x** –Ω–∞ **2.x.x** –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:

1. –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–π –ø–∞–∫–µ—Ç:
   ```bash
   opkg remove keenetic-pbr
   ```
2. –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ –Ω–æ–≤—É—é –ø–∞–ø–∫—É:
   ```bash
   # –ö–æ–ø–∏—Ä—É–µ–º –ø–∞–ø–∫—É keenetic-pbr –≤ keen-pbr 
   cp -r /opt/etc/keenetic-pbr /opt/etc/keen-pbr
   
   # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º keenetic-pbr.conf –≤ keen-pbr.conf
   mv /opt/etc/keen-pbr/keenetic-pbr.conf /opt/etc/keen-pbr/keen-pbr.conf
   
   # –ó–∞–º–µ–Ω—è–µ–º –ø—É—Ç–∏ –≤–Ω—É—Ç—Ä–∏ —Ñ–∞–π–ª–∞ keen-pbr.conf
   sed -i 's|/keenetic-pbr/|/keen-pbr/|g' /opt/etc/keen-pbr/keen-pbr.conf
   ```
3. –°–ª–µ–¥—É–π—Ç–µ –¥–∞–ª—å–Ω–µ–π—à–∏–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Å –Ω—É–ª—è –Ω–∏–∂–µ.

---

</details>

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
   ```bash
   opkg update
   opkg install ca-certificates wget-ssl
   opkg remove wget-nossl
   ```
 
2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ opkg-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤ —Å–∏—Å—Ç–µ–º—É
   ```bash
   mkdir -p /opt/etc/opkg
   ARCH=$(opkg print-architecture | grep -v 'all' | awk 'NR==1{print $2}' | cut -d'-' -f1)
   echo "Adding keen-pbr repository for architecture \"${ARCH}\""
   echo "src/gz keen-pbr https://maksimkurb.github.io/keen-pbr/${ARCH}" > /opt/etc/opkg/keen-pbr.conf
   ```
   –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã: `mips`, `mipsel`, `aarch64`.
 
3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–∞–∫–µ—Ç:
   ```bash
   opkg update
   opkg install keen-pbr
   ```

   –í–æ –≤—Ä–µ–º—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∞–∫–µ—Ç `keen-pbr` –∑–∞–º–µ–Ω—è–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ **dnsmasq**.
   –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ `/opt/etc/dnsmasq.conf.orig`.
   
> [!CAUTION]  
> –ï—Å–ª–∏ Entware —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –ø–∞–º—è—Ç—å —Ä–æ—É—Ç–µ—Ä–∞, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ [–æ—Ç–∫–ª—é—á–∏—Ç–µ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤](#config-step-3), —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∏–∑–Ω–æ—Å –ø–∞–º—è—Ç–∏!

#### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ:
```bash
opkg update
opkg upgrade keen-pbr
``` 

#### –£–¥–∞–ª–µ–Ω–∏–µ
```bash
opkg remove --autoremove keen-pbr
```

#### –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏
```bash
opkg info keen-pbr
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —Ñ–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –≤–∞—à–∏–º–∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è–º–∏ (–ø–æ–¥—Ä–æ–±–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–∏–∂–µ):

1. **(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) [–ù–∞—Å—Ç—Ä–æ–π–∫–µ –ø–∞–∫–µ—Ç keen-pbr](#config-step-1)**
    - In this file, you must configure the required ipsets, lists, and output interfaces
2. **(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) [–°–∫–∞—á–∞–π—Ç–µ —É–¥–∞–ª—ë–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å —Å–ø–∏—Å–∫–∏ —Å `url="..."`)](#config-step-2)**
3. **(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) [–û—Ç–∫–ª—é—á–∏—Ç–µ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤](#config-step-3)**
    - If Entware is installed on internal memory, it is strongly recommended to [disable lists auto-update](#config-step-3) to prevent NAND-flash memory wear
4. **(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) [–ù–∞—Å—Ç—Ä–æ–π—Ç–µ DNS over HTTPS (DoH)](#config-step-4)**
    - dnsmasq –º–æ–∂–Ω–æ –ø–µ—Ä–µ–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥ —Å–≤–æ–∏ –Ω—É–∂–¥—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä –∑–∞–º–µ–Ω–∏—Ç—å upstream DNS —Å–µ—Ä–≤–µ—Ä –Ω–∞ —Å–≤–æ–π
    - –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–∞–∫–µ—Ç `dnscrypt-proxy2`, —á—Ç–æ–±—ã –≤–∞—à–∏ DNS-–∑–∞–ø—Ä–æ—Å—ã –±—ã–ª–∏ –∑–∞—â–∏—â–µ–Ω—ã DNS-over-HTTPS (DoH)
5. **(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) [–í–∫–ª—é—á–µ–Ω–∏–µ DNS Override](#config-step-5)**

<a name="config-step-1"></a>
### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞–∫–µ—Ç–∞ keen-pbr

–û—Ç–∫—Ä–æ–π—Ç–µ `/opt/etc/keen-pbr/keen-pbr.conf` –∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –µ–≥–æ –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏:

1. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª–µ `interfaces`, —É–∫–∞–∑–∞–≤ —Ç—É–¥–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏–¥—Ç–∏ –∏—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–∞—Ñ–∏–∫, –ø–æ–ø–∞–≤—à–∏–π –ø–æ–¥ –∫—Ä–∏—Ç–µ—Ä–∏–∏ —Å–ø–∏—Å–∫–æ–≤.
2. –¢–∞–∫–∂–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–ø–∏—Å–∫–∏ (–ª–æ–∫–∞–ª—å–Ω—ã–π –∏–ª–∏ —É–¥–∞–ª—ë–Ω–Ω—ã–π –ø–æ URL)

<a name="config-step-2"></a>
### 2. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤

–ü–æ—Å–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—É—é –∫–æ–º–∞–Ω–¥—É, —á—Ç–æ–±—ã —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª—ã —Å–ø–∏—Å–∫–æ–≤.

–≠—Ç—É –∫–æ–º–∞–Ω–¥—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É –í–∞—Å –µ—Å—Ç—å —Ö–æ—Ç—è-–±—ã –æ–¥–∏–Ω —É–¥–∞–ª—ë–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ (–ø–æ–ª–µ `url` —É–∫–∞–∑–∞–Ω–æ —Ö–æ—Ç—è-–±—ã –¥–ª—è –æ–¥–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞).

```bash
keen-pbr download
```

<a name="config-step-3"></a>
### 3. –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–æ–≤
> [!CAUTION]
> –ï—Å–ª–∏ Entware —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –ø–∞–º—è—Ç—å —Ä–æ—É—Ç–µ—Ä–∞, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç–µ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∏–∑–Ω–æ—Å –ø–∞–º—è—Ç–∏.
>
> –≠—Ç—É –∫–æ–º–∞–Ω–¥—É –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å **–ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞–∫–µ—Ç–∞ keen-pbr**!

–î–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –æ—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤, —É–¥–∞–ª–∏—Ç–µ —Ñ–∞–π–ª `/opt/etc/cron.daily/50-keen-pbr-lists-update.sh`:
```bash
rm /opt/etc/cron.daily/50-keen-pbr-lists-update.sh
```

–í—ã –≤—Å–µ–≥–¥–∞ —Å–º–æ–∂–µ—Ç–µ [–æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–∫–∏ –≤—Ä—É—á–Ω—É—é](#lists-update).

<a name="config-step-4"></a>
### 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ DNS over HTTPS (DoH)
> [!TIP]  
> –û–±—ã—á–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª DNS —è–≤–ª—è–µ—Ç—Å—è –Ω–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–º, –ø–æ—Å–∫–æ–ª—å–∫—É –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ.
> –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä –∏–ª–∏ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–∏ –º–æ–≥—É—Ç –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç—å –∏ –ø–æ–¥–º–µ–Ω–∏—Ç—å –≤–∞—à–∏ DNS-–∑–∞–ø—Ä–æ—Å—ã ([DNS spoofing](https://ru.wikipedia.org/wiki/DNS_spoofing)), –Ω–∞–ø—Ä–∞–≤–∏–≤ –≤–∞—Å –Ω–∞ –Ω–µ–Ω–∞—Å—Ç–æ—è—â–∏–π –≤–µ–±-—Å–∞–π—Ç.
> 
> –ß—Ç–æ–±—ã –æ–±–µ–∑–æ–ø–∞—Å–∏—Ç—å —Å–µ–±—è –æ—Ç —ç—Ç–æ–≥–æ, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–∞–∫–µ—Ç `dnscrypt-proxy2`, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª **DNS-over-HTTPS** (**DoH**) –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è DNS-–∑–∞–ø—Ä–æ—Å–æ–≤.
> –ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ **DoH** [–º–æ–∂–Ω–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∑–¥–µ—Å—å](https://adguard-dns.io/ru/blog/adguard-dns-announcement.html).

–î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ **DoH** –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:
1. –°–∫–∞—á–∏–≤–∞–µ–º `dnscrypt-proxy2`
    ```bash
    opkg install dnscrypt-proxy2
    ```
2. –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª `/opt/etc/dnscrypt-proxy.toml`
    ```ini
   # ... (–∑–¥–µ—Å—å –¥—Ä—É–≥–∏–µ —Å—Ç—Ä–æ—á–∫–∏ –∫–æ–Ω—Ñ–∏–≥–∞, –∏—Ö —É–¥–∞–ª—è—Ç—å –Ω–µ –Ω—É–∂–Ω–æ)
   
   # –£–∫–∞–∑—ã–≤–∞–µ–º upstream-—Å–µ—Ä–≤–µ—Ä—ã (–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–±—Ä–∞—Ç—å —Ä–µ—à—ë—Ç–∫—É –ø–µ—Ä–µ–¥ server_names)
   server_names = ['adguard-dns-doh', 'cloudflare-security', 'google']
   
   # –£–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Ä—Ç 9153 –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è DNS-–∑–∞–ø—Ä–æ—Å–æ–≤
   listen_addresses = ['[::]:9153']
   
   # ... (–∑–¥–µ—Å—å –¥—Ä—É–≥–∏–µ —Å—Ç—Ä–æ—á–∫–∏ –∫–æ–Ω—Ñ–∏–≥–∞, –∏—Ö —É–¥–∞–ª—è—Ç—å –Ω–µ –Ω—É–∂–Ω–æ)
    ```
3. –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª `/opt/etc/dnsmasq.conf`
    ```ini
   # ... (–∑–¥–µ—Å—å –¥—Ä—É–≥–∏–µ —Å—Ç—Ä–æ—á–∫–∏ –∫–æ–Ω—Ñ–∏–≥–∞, –∏—Ö —É–¥–∞–ª—è—Ç—å –Ω–µ –Ω—É–∂–Ω–æ)
   
   # –ú–µ–Ω—è–µ–º —Å–µ—Ä–≤–µ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 8.8.8.8 –Ω–∞ –Ω–∞—à dnscrypt-proxy2
   server=127.0.0.1#9153
   
   # ... (–∑–¥–µ—Å—å –¥—Ä—É–≥–∏–µ —Å—Ç—Ä–æ—á–∫–∏ –∫–æ–Ω—Ñ–∏–≥–∞, –∏—Ö —É–¥–∞–ª—è—Ç—å –Ω–µ –Ω—É–∂–Ω–æ)
    ```

4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    ```bash
   # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥ dnsmasq
   dnsmasq --test
   # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥ dnscrypt-proxy2 (–∑–∞–ø—É—Å–∫–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω dnscrypt-proxy2)
   dnscrypt-proxy -config /opt/etc/dnscrypt-proxy.toml -check
   ```

<a name="config-step-5"></a>
### 5. –í–∫–ª—é—á–µ–Ω–∏–µ DNS Override

–î–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã Keenetic –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª `dnsmasq` –≤ –∫–∞—á–µ—Å—Ç–≤–µ DNS-—Å–µ—Ä–≤–µ—Ä–∞, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–∫–ª—é—á–∏—Ç—å **DNS Override**.

> [!NOTE]  
> –î–∞–Ω–Ω—ã–π —ç—Ç–∞–ø –Ω–µ –Ω—É–∂–µ–Ω, –µ—Å–ª–∏ –≤–∞—à–∏ —Å–ø–∏—Å–∫–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–æ–ª—å–∫–æ IP-–∞–¥—Ä–µ—Å–∞ –∏ CIDR –∏ –Ω–µ —É–∫–∞–∑—ã–≤–∞—é—Ç –¥–æ–º–µ–Ω–Ω—ã—Ö –∏–º—ë–Ω.


1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π URL –≤ –±—Ä–∞—É–∑–µ—Ä–µ: http://my.keenetic.net/a
2. –í–≤–µ–¥–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã –ø–æ –æ—á–µ—Ä–µ–¥–∏:
   - `opkg dns-override`
   - `system configuration save`
3. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ **–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ä–æ—É—Ç–µ—Ä**.

> [!TIP]
> –ï—Å–ª–∏ –≤—ã —Ä–µ—à–∏—Ç–µ –æ—Ç–∫–ª—é—á–∏—Ç—å DNS-Override –≤ –±—É–¥—É—â–µ–º, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—ã `no opkg dns-override` –∏ `system configuration save`.

### 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª–∏—Ç–∏–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–æ–ª–∂–Ω—ã–º –æ–±—Ä–∞–∑–æ–º.

–î–ª—è —ç—Ç–æ–≥–æ –æ—Ç–∫—Ä–æ–π—Ç–µ –∞–¥—Ä–µ—Å, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç –≤ –≤–∞—à–∏—Ö —Å–ø–∏—Å–∫–∞—Ö (–Ω–∞–ø—Ä. https://2ip.ru) –∏ –∞–¥—Ä–µ—Å, –∫–æ—Ç–æ—Ä—ã–π –µ—Å—Ç—å –≤ –≤–∞—à–∏—Ö —Å–ø–∏—Å–∫–∞—Ö (–Ω–∞–ø—Ä. https://ifconfig.co) –∏ —Å—Ä–∞–≤–Ω–∏—Ç–µ IP-–∞–¥—Ä–µ—Å–∞, –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–∞–∑–Ω—ã–º–∏.

<a name="lists-update"></a>
## –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤

* –°–ø–∏—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ —Å –ø–æ–º–æ—â—å—é `cron`.
  * –ï—Å–ª–∏ Entware —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –ø–∞–º—è—Ç—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, [–æ—Ç–∫–ª—é—á–∏—Ç–µ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤](#config-step-3), —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∏–∑–Ω–æ—Å –ø–∞–º—è—Ç–∏.

–í —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ –≤—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ `keen-pbr.conf` –∏ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–∫–∏ –≤—Ä—É—á–Ω—É—é, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã –ø–æ SSH:

```bash
# –ï—Å–ª–∏ –≤—ã –¥–æ–±–∞–≤–∏–ª–∏ –Ω–æ–≤—ã–µ —É–¥–∞–ª—ë–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–∫–∞—á–∞—Ç—å –∏—Ö
keen-pbr download

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:
/opt/etc/init.d/S80keen-pbr restart
/opt/etc/init.d/S56dnsmasq restart
```

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –ø—Ä–æ–±–ª–µ–º—ã, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ –ª–æ–≥–∏.
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–ø–∏—Å–∫–∏ –±—ã–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –∏ `dnsmasq` —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π.

–ü–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –º–∞—à–∏–Ω–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—á–∏—Å—Ç–∏—Ç—å DNS-–∫–µ—à.
–°–¥–µ–ª–∞—Ç—å —ç—Ç–æ –≤—ã–ø–æ–ª–Ω–∏–≤ –∫–æ–º–∞–Ω–¥—É –≤ –∫–æ–Ω—Å–æ–ª–∏ (–¥–ª—è Windows): `ipconfig /flushdns`.

–¢–∞–∫–∂–µ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â—É—é –∫–æ–º–∞–Ω–¥—É, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç **keen-pbr** (–≤—ã–≤–æ–¥ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã –±—É–¥–µ—Ç –æ—á–µ–Ω—å –ø–æ–ª–µ–∑–µ–Ω, –µ—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –ø–æ–º–æ—â—å –≤ Telegram-—á–∞—Ç–µ):
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ dnsmasq –∑–∞–ø—É—â–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
/opt/etc/init.d/S80keen-pbr check

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
/opt/etc/init.d/S80keen-pbr self-check
```

–í—ã –º–æ–∂–µ—Ç–µ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –≤ Telegram-—á–∞—Ç–µ –ø—Ä–æ–µ–∫—Ç–∞: https://t.me/keen_pbr

## –Ø –≤—Å—ë –ø–æ–ª–æ–º–∞–ª, –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –ø—Ä–æ–ø–∞–ª –≤–æ–≤—Å–µ

–ú–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –¥–∞–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é, –≤—ã–∫–ª—é—á–∏–≤ **OPKG** –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö (–≤—ã–±—Ä–∞–≤ —Ä–∞–∑–¥–µ–ª="–Ω–µ —É–∫–∞–∑–∞–Ω") –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–≤ —Ä–æ—É—Ç–µ—Ä.

–ï—Å–ª–∏ –∂–µ–ª–∞–µ—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–∏—Ç—å –ø–∞–∫–µ—Ç, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
1. –ü–æ SSH –≤—ã–ø–æ–ª–Ω–∏—Ç—å: `opkg remove keen-pbr dnsmasq dnscrypt-proxy2`
2. –û—Ç–∫–ª—é—á–∏—Ç—å DNS-override (http://my.keenetic.net/a):
    - `no opkg dns-override`
    - `system configuration save`
3. –í—ã–∫–ª—é—á–∏—Ç—å **OPKG** (–µ—Å–ª–∏ –Ω–µ –ø–æ–ª—å–∑—É–µ—Ç–µ—Å—å –∏–º –¥–ª—è –¥—Ä—É–≥–∏—Ö –Ω—É–∂–¥)
4. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–æ—É—Ç–µ—Ä

### –ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–∞

1. –ü–æ SSH –≤—ã–ø–æ–ª–Ω–∏—Ç—å: `opkg remove keen-pbr dnsmasq dnscrypt-proxy2`
2. –û—Ç–∫–ª—é—á–∏—Ç—å DNS-override (http://my.keenetic.net/a):
    - `no opkg dns-override`
    - `system configuration save`
3. –í—ã–∫–ª—é—á–∏—Ç—å **OPKG** (–µ—Å–ª–∏ –Ω–µ –ø–æ–ª—å–∑—É–µ—Ç–µ—Å—å –∏–º –¥–ª—è –¥—Ä—É–≥–∏—Ö –Ω—É–∂–¥)
4. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–æ—É—Ç–µ—Ä

---

–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª–∏—Ç–∏–∫–∏ —Å **keen-pbr**!
